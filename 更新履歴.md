# 三角比小テスト 更新履歴

## 2025年11月6日 - 送信失敗時の手動再送信ボタン表示を改善

### 不具合修正
1. **手動再送信ボタンの表示改善**
   - 送信失敗時にボタンが表示されない問題を修正
   - `classList.remove('hidden')`に加えて`style.display = 'block'`も明示的に設定
   - ボタンの非表示時も`style.display = 'none'`を明示的に設定

2. **デバッグ機能の追加**
   - `updateSendStatus`関数にデバッグログを追加
   - ボタンの存在確認とログ出力で問題の特定を容易に

3. **リセット処理の強化**
   - `resetQuiz`関数で送信状態を完全にリセット
   - 送信状態変数（sendStatus、retryCount、lastSendData）のクリア
   - 送信状態表示とボタンの非表示処理を追加

---

## 2025年11月5日 - カンニング防止機能を実装

### カンニング防止
1. **アプリ切り替え検出**
   - visibilitychangeイベントでバックグラウンド切り替えを検出
   - テスト中にアプリを切り替えるとテストをリセット

2. **ウィンドウフォーカス監視**
   - blurイベントでフォーカス喪失を検出
   - 他のウィンドウやアプリに切り替えたらリセット

3. **画面サイズ変更検出（Split View対策）**
   - テスト開始時に画面サイズを記録
   - 50px以上の変更で検出（iPadのSplit Viewなど）
   - デバウンス処理（300ms）で誤検知を防止

4. **共通リセット関数**
   - テストリセット処理を関数化して保守性向上
   - リセット時にメニュー画面に戻り、警告メッセージを表示

---

## 2025年10月30日 - データ送信の信頼性向上とiPad対応強化

### データ送信の改善
1. **自動リトライ機能**
   - 送信失敗時に自動的に3回まで再送信（3秒間隔）
   - CORSエラー時は自動的にno-corsモードにフォールバック

2. **送信状態の可視化**
   - 「送信中...」「再送信中... (1/3)」「送信完了」「送信に失敗しました」を表示
   - 色分けで状態を視覚的に表示（青→オレンジ→緑/赤）
   - 送信完了メッセージは常時表示（消えない）

3. **手動再送信ボタン**
   - 自動リトライが失敗した場合、ユーザーが手動で再送信可能
   - 赤い「手動で再送信」ボタンが表示される

### iPad対応の強化
1. **スクロール問題の完全修正**
   - 縦画面での慣性スクロール後に画面が戻る問題を解決
   - 説明画面で「テスト開始」ボタンが確実に押せるように改善
   - ハードウェアアクセラレーション有効化

### Google Apps Script強化
1. **時刻記録機能の追加**
   - `recordStartTime()`: テスト開始時刻をF1セルに記録
   - `recordEndTime()`: テスト終了時刻をG1セルに記録
   - スプレッドシートのボタンから呼び出し可能

---

## 2025年10月27日 - 角度を求めるモード追加とテストタイプ送信機能

### 主要な機能追加
1. **角度を求めるテストモードを追加**
   - 「値を求める」に加えて「角度を求める」モードを実装
   - 角度モード: 9つの角度ボタンから1つまたは2つを選択
   - 値モード: 全27問、角度モード: 全21問（同じ値を持つ角度を1問にまとめ、「tan θ = なし」を除外）

2. **メニュー画面と説明画面を追加**
   - テストタイプ選択メニュー
   - 各テストタイプの説明画面（回答方法・注意事項）
   - 実際のボタン配置例をKaTeXで表示

3. **練習モードを削除**
   - 常に全問題を出題（値: 27問、角度: 21問）
   - すべての結果をスプレッドシートに記録
   - Googleログインが必須

4. **スプレッドシートへのデータ送信強化**
   - H列に「テストタイプ」を追加
   - 「値を求める」または「角度を求める」を記録
   - FILTER関数で特定のテストタイプを抽出可能

### UI改善
1. **選択肢ボタンの幅を統一**
   - 全ボタンを190pxに統一（iPad: 165px、モバイル: 可変）
   - 「√2/2 = 1/√2」のような併記表示に対応
   - 4段目のボタンも他と同じ幅で表示

2. **KaTeX表記の統一**
   - メニュー画面の説明文
   - 説明画面の選択肢例
   - 問題文と選択肢
   - 結果画面

### 技術的な改善
- CSS Grid レイアウトで正確な配置を実現
- position: relative を使った4段目のオフセット配置
- レスポンシブ対応（デスクトップ、iPad、モバイル）

---

## 2025年10月24日以前
- 初期バージョン
- 値を求めるテストのみ
- 練習モード・テストモードの切り替え機能
