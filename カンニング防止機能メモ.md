# カンニング防止機能メモ

このファイルには、一旦削除したカンニング防止機能の詳細を記録しています。
将来的に再度追加する際に参照してください。

## 削除日時
2025年11月7日

## 機能概要

以下の3つの方法でカンニング行為を検出し、テストをリセットする機能：

1. **アプリ切り替え検出** - 他のアプリに切り替えた場合
2. **ウィンドウフォーカス監視** - ウィンドウからフォーカスが外れた場合
3. **画面サイズ変更検出** - Split Viewなどで画面サイズが変更された場合

## グローバル変数

```javascript
let testStartWidth = null;
let testStartHeight = null;
let resizeTimeout = null;
let monitoringEnabled = false; // 監視が有効かどうか
```

## 関数定義

### 1. resetTestForCheating関数（154-178行目）

```javascript
// カンニング防止：テストリセット処理（共通関数）
function resetTestForCheating(reason) {
    // テスト中（クイズ画面が表示されている）かチェック
    if (!quizScreen.classList.contains('hidden')) {
        console.log(`カンニング防止: ${reason}`);

        // テストをリセット
        currentQuestionIndex = 0;
        userAnswers = [];
        selectedProblems = [];
        selectedAngles = [];
        selectedChoice = null;
        startTime = null;
        testStartWidth = null;
        testStartHeight = null;
        monitoringEnabled = false; // 監視を無効化

        // クイズ画面を非表示にしてメニュー画面に戻る
        quizScreen.classList.add('hidden');
        menuScreen.classList.remove('hidden');

        // 警告メッセージを表示
        alert(`${reason}のため、テストがリセットされました。`);
    }
}
```

### 2. recordInitialScreenSize関数（203-207行目）

```javascript
// テスト開始時にサイズを記録する関数
function recordInitialScreenSize() {
    testStartWidth = window.innerWidth;
    testStartHeight = window.innerHeight;
    console.log(`テスト開始時の画面サイズ: ${testStartWidth} x ${testStartHeight}`);
}
```

### 3. enableMonitoring関数（210-216行目）

```javascript
// 監視を開始する関数（遅延実行）
function enableMonitoring() {
    // 2秒後に監視を有効化（画面遷移が安定してから）
    setTimeout(() => {
        monitoringEnabled = true;
        console.log('カンニング防止監視を開始しました');
    }, 2000);
}
```

## イベントリスナー

### 1. アプリ切り替え検出（181-186行目）

```javascript
// カンニング防止：アプリ切り替え検出
document.addEventListener('visibilitychange', () => {
    // 監視が有効な場合のみチェック
    if (document.hidden && monitoringEnabled) {
        resetTestForCheating('アプリを切り替えた');
    }
});
```

### 2. ウィンドウフォーカス監視（189-194行目）

```javascript
// カンニング防止：ウィンドウフォーカス監視
window.addEventListener('blur', () => {
    // 監視が有効な場合のみチェック
    if (monitoringEnabled) {
        resetTestForCheating('ウィンドウのフォーカスが外れた');
    }
});
```

### 3. 画面サイズ変更検出（218-237行目）

```javascript
window.addEventListener('resize', () => {
    // テスト中かつ監視が有効な場合のみチェック
    if (!quizScreen.classList.contains('hidden') && testStartWidth !== null && monitoringEnabled) {
        // デバウンス: 連続した発火を防ぐため300ms待つ
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            const widthChanged = Math.abs(window.innerWidth - testStartWidth) > 50;
            const heightChanged = Math.abs(window.innerHeight - testStartHeight) > 50;

            console.log(`画面サイズ変更検出: ${window.innerWidth} x ${window.innerHeight} (開始時: ${testStartWidth} x ${testStartHeight})`);

            if (widthChanged || heightChanged) {
                resetTestForCheating('画面サイズが変更された（Split Viewなど）');
                // リセット後はサイズ記録をクリア
                testStartWidth = null;
                testStartHeight = null;
            }
        }, 300);
    }
});
```

## startQuiz関数への追加部分（563-568行目）

```javascript
// カンニング防止: 画面遷移完了後に画面サイズを記録して監視を開始
// 画面が安定してから記録するために500ms待つ
setTimeout(() => {
    recordInitialScreenSize();
    enableMonitoring(); // 2秒後に監視開始
}, 500);
```

この部分は`startQuiz`関数の最後に追加されています。

## resetTestForCheating関数内でリセットする変数（166-168行目）

```javascript
testStartWidth = null;
testStartHeight = null;
monitoringEnabled = false; // 監視を無効化
```

## 再度追加する際の手順

1. グローバル変数の宣言を追加（197-200行目付近）
2. `resetTestForCheating`関数を追加（154-178行目）
3. `recordInitialScreenSize`関数を追加（203-207行目）
4. `enableMonitoring`関数を追加（210-216行目）
5. `visibilitychange`イベントリスナーを追加（181-186行目）
6. `blur`イベントリスナーを追加（189-194行目）
7. `resize`イベントリスナーを追加（218-237行目）
8. `startQuiz`関数の最後に監視開始処理を追加（563-568行目）
9. `resetTestForCheating`関数内でカンニング防止関連変数をリセット（166-168行目）

## 注意事項

- 監視は画面遷移から2.5秒後に有効化される（画面安定までの500ms + 監視開始までの2000ms）
- 画面サイズの変更は50px以上の差で検出
- リサイズイベントは300msのデバウンスを設定
- テスト中（`quizScreen`が表示中）のみ監視が作動
