<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三角比小テスト - 使い方ガイド</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN', sans-serif;
            line-height: 1.7;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        h2 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        h3 {
            color: #764ba2;
            font-size: 1.3em;
            margin: 25px 0 15px 0;
        }

        .link-box {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .link-box h3 {
            margin-top: 0;
            color: #667eea;
        }

        .link-box a {
            display: block;
            color: #667eea;
            text-decoration: none;
            padding: 10px 15px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            transition: all 0.3s;
            word-break: break-all;
        }

        .link-box a:hover {
            background: #667eea;
            color: white;
            transform: translateX(10px);
        }

        .url-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            border-radius: 5px;
            padding: 10px 15px;
            margin: 5px 0;
        }

        .url-text {
            flex: 1;
            color: #667eea;
            text-decoration: none;
            word-break: break-all;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .copy-btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        .copy-btn:active {
            transform: scale(0.95);
        }

        .copy-btn.copied {
            background: #28a745;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin: 5px 5px 5px 0;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .info-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #667eea30;
        }

        .info-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .info-card p {
            color: #555;
            font-size: 0.95em;
        }

        ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        li {
            margin: 10px 0;
        }

        code {
            background: #f4f4f4;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }

        .warning {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .tip {
            background: #d1ecf1;
            border-left: 5px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }

        .btn {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            margin: 10px 5px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .quick-links {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 30px 0;
        }

        .back-link {
            display: inline-block;
            color: #667eea;
            text-decoration: none;
            padding: 10px 20px;
            margin-bottom: 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            transition: all 0.3s;
            font-weight: bold;
        }

        .back-link:hover {
            background: #667eea;
            color: white;
            transform: translateX(-5px);
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>三角比小テスト</h1>
            <p>使い方ガイド & リンク集</p>
        </header>

        <div class="content">
            <!-- トップページへ戻る -->
            <a href="readme.html" class="back-link">← トップページに戻る</a>

            <!-- クイックアクセスリンク -->
            <div class="section">
                <h2>🚀 クイックアクセス</h2>
                <div class="quick-links">
                    <a href="https://ishiyamayoshihiro-lgtm.github.io/-/" class="btn" target="_blank">📝 テストを開始</a>
                    <a href="https://docs.google.com/spreadsheets/d/1tryBWpHzBJzltuSbmZlr1rtwMirGR44xK8H84sgCu7I/edit" class="btn" target="_blank">📊 結果を確認</a>
                </div>
            </div>

            <!-- 現在の状態 -->
            <div class="section">
                <h2>📌 現在の状態</h2>
                <div>
                    <span class="status-badge status-success">✓ 値を求める/角度を求める 2モード対応</span>
                    <span class="status-badge status-success">✓ GitHub Pages公開済み</span>
                    <span class="status-badge status-success">✓ スプレッドシート連携完了</span>
                    <span class="status-badge status-success">✓ 自動リトライ機能搭載</span>
                    <span class="status-badge status-info">iPad / PC 対応</span>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <h4>📝 値を求める</h4>
                        <p>全27問・選択肢から値を選択</p>
                    </div>
                    <div class="info-card">
                        <h4>📐 角度を求める</h4>
                        <p>全21問・角度ボタンから選択（複数選択可）</p>
                    </div>
                    <div class="info-card">
                        <h4>✨ 数式表示</h4>
                        <p>KaTeXで美しいTeX表記（sin 0°など）</p>
                    </div>
                    <div class="info-card">
                        <h4>🔄 送信信頼性</h4>
                        <p>自動3回リトライ + 手動再送信ボタン</p>
                    </div>
                </div>
            </div>

            <!-- 重要なリンク -->
            <div class="section">
                <h2>🔗 重要なリンク</h2>

                <div class="link-box">
                    <h3>📱 アプリケーション</h3>
                    <div class="url-container">
                        <a href="https://ishiyamayoshihiro-lgtm.github.io/-/" target="_blank" class="url-text">
                            🌐 三角比小テスト（本番環境）<br>
                            <small>https://ishiyamayoshihiro-lgtm.github.io/-/</small>
                        </a>
                        <button class="copy-btn" onclick="copyToClipboard('https://ishiyamayoshihiro-lgtm.github.io/-/', this)">
                            📋 コピー
                        </button>
                    </div>
                </div>

                <div class="link-box">
                    <h3>📊 データ管理</h3>
                    <a href="https://docs.google.com/spreadsheets/d/1tryBWpHzBJzltuSbmZlr1rtwMirGR44xK8H84sgCu7I/edit" target="_blank">
                        📈 結果記録スプレッドシート<br>
                        <small>テスト結果を確認・集計</small>
                    </a>
                </div>

                <div class="link-box">
                    <h3>💻 開発・管理</h3>
                    <a href="https://github.com/ishiyamayoshihiro-lgtm/-" target="_blank">
                        📦 GitHubリポジトリ<br>
                        <small>ソースコード管理</small>
                    </a>
                    <a href="https://console.cloud.google.com/" target="_blank">
                        ☁️ Google Cloud Console<br>
                        <small>OAuth設定・認証管理</small>
                    </a>
                    <a href="https://script.google.com/home" target="_blank">
                        ⚙️ Google Apps Script<br>
                        <small>スプレッドシート連携スクリプト</small>
                    </a>
                </div>
            </div>

            <!-- 使い方 -->
            <div class="section">
                <h2>📖 使い方</h2>

                <h3>生徒がテストを受ける手順</h3>
                <ol>
                    <li>以下のURLにアクセス:<br>
                        <code>https://ishiyamayoshihiro-lgtm.github.io/-/</code>
                    </li>
                    <li>「Googleアカウントでログイン」ボタンをクリック</li>
                    <li>学校または個人のGoogleアカウントでログイン</li>
                    <li>テストタイプを選択（「値を求める」または「角度を求める」）</li>
                    <li>説明を読んで「テスト開始」ボタンをクリック</li>
                    <li>全問題に回答（値: 27問、角度: 21問）</li>
                    <li>結果が自動的にスプレッドシートに記録されます
                        <ul>
                            <li>送信状態が画面に表示されます（「送信完了」が表示されればOK）</li>
                            <li>失敗した場合は「手動で再送信」ボタンが表示されます</li>
                        </ul>
                    </li>
                </ol>

                <h3>教師が結果を確認する手順</h3>
                <ol>
                    <li><a href="https://docs.google.com/spreadsheets/d/1tryBWpHzBJzltuSbmZlr1rtwMirGR44xK8H84sgCu7I/edit" target="_blank">結果記録スプレッドシート</a>を開く</li>
                    <li>以下の情報が記録されています:
                        <ul>
                            <li>日時</li>
                            <li>メールアドレス</li>
                            <li>正解数 / 総問題数</li>
                            <li>正答率（%）</li>
                            <li>経過時間</li>
                        </ul>
                    </li>
                    <li>スプレッドシートで並び替え・フィルタ・グラフ作成が可能</li>
                </ol>
            </div>

            <!-- スプレッドシート記録内容 -->
            <div class="section">
                <h2>📊 スプレッドシート記録内容</h2>
                <p>テスト完了時に以下の情報が自動的に記録されます:</p>
                <ul>
                    <li><strong>日時:</strong> テスト実施日時</li>
                    <li><strong>メールアドレス:</strong> ログインしたGoogleアカウント</li>
                    <li><strong>正解数:</strong> 正解した問題の数</li>
                    <li><strong>総問題数:</strong> 値を求める: 27問、角度を求める: 21問</li>
                    <li><strong>正答率(%):</strong> 自動計算された正答率</li>
                    <li><strong>経過時間（秒）:</strong> テスト開始から終了までの秒数</li>
                    <li><strong>経過時間（表示用）:</strong> 「○分○秒」形式</li>
                    <li><strong>テストタイプ:</strong> 「値を求める」または「角度を求める」</li>
                </ul>

                <div class="tip">
                    <strong>💡 F1・G1セルでテスト期間を管理</strong><br>
                    スプレッドシートのF1セルに開始時刻、G1セルに終了時刻を記録できます。<br>
                    Google Apps Scriptの<code>recordStartTime()</code>と<code>recordEndTime()</code>関数を<br>
                    ボタンに割り当てて使用してください。FILTER関数で期間内のデータを抽出できます。
                </div>
            </div>

            <!-- 技術情報 -->
            <div class="section">
                <h2>⚙️ 技術情報</h2>

                <h3>使用技術</h3>
                <ul>
                    <li><strong>フロントエンド:</strong> HTML, CSS, JavaScript</li>
                    <li><strong>数式表示:</strong> KaTeX（TeX記法で美しい数式表示）</li>
                    <li><strong>認証:</strong> Google OAuth 2.0</li>
                    <li><strong>データ保存:</strong> Google Apps Script + Google Spreadsheet</li>
                    <li><strong>ホスティング:</strong> GitHub Pages</li>
                    <li><strong>レイアウト:</strong> CSSグリッド（値の大きさ順配置）</li>
                </ul>

                <h3>Google Cloud Platform情報</h3>
                <ul>
                    <li><strong>プロジェクト名:</strong> 三角比テスト</li>
                    <li><strong>OAuth 2.0 クライアントID:</strong><br>
                        <code>1081498976325-2cbnp1qvk2u9cnltrc3nk2jkqfgkrbue.apps.googleusercontent.com</code>
                    </li>
                    <li><strong>承認済みURL:</strong>
                        <ul>
                            <li><code>http://localhost:8000</code> (開発用)</li>
                            <li><code>https://ishiyamayoshihiro-lgtm.github.io</code> (本番)</li>
                        </ul>
                    </li>
                </ul>
            </div>

            <!-- トラブルシューティング -->
            <div class="section">
                <h2>🔧 トラブルシューティング</h2>

                <h3>ログインできない / 認証エラー</h3>
                <div class="tip">
                    <strong>解決方法:</strong>
                    <ul>
                        <li>ブラウザのキャッシュをクリア（Ctrl + Shift + R でスーパーリロード）</li>
                        <li>シークレット/プライベートモードで開く</li>
                        <li>別のブラウザで試す</li>
                    </ul>
                </div>

                <h3>スプレッドシートに記録されない</h3>
                <div class="tip">
                    <strong>確認事項:</strong>
                    <ul>
                        <li>ログインが成功しているか確認</li>
                        <li>テストを最後まで完了したか確認</li>
                        <li>ブラウザのコンソール（F12）でエラーを確認</li>
                    </ul>
                </div>

                <h3>古いバージョンが表示される（3問のまま）</h3>
                <div class="tip">
                    <strong>解決方法:</strong>
                    <ul>
                        <li><strong>Ctrl + Shift + R</strong> (Windows) または <strong>Cmd + Shift + R</strong> (Mac) でスーパーリロード</li>
                        <li>ブラウザのキャッシュを削除</li>
                        <li>シークレットモードで確認</li>
                    </ul>
                </div>
            </div>

            <!-- セキュリティ -->
            <div class="section">
                <h2>🔐 セキュリティ注意事項</h2>
                <div class="warning">
                    <ul>
                        <li>OAuth クライアントIDは公開情報なので問題ありません</li>
                        <li>クライアントシークレットは使用していません</li>
                        <li>スプレッドシートの共有設定に注意してください</li>
                        <li>個人情報（メールアドレス）が記録されるため、適切に管理してください</li>
                    </ul>
                </div>
            </div>

            <!-- ファイル構成 -->
            <div class="section">
                <h2>📁 ファイル構成</h2>
                <ul>
                    <li><code>index.html</code> - メインのHTMLファイル（自動リダイレクト機能付き）</li>
                    <li><code>style.css</code> - スタイルシート（4列グリッド、スクロール最適化）</li>
                    <li><code>script.js</code> - メインロジック（2モード対応、リトライ機能搭載）</li>
                    <li><code>config.js</code> - OAuth設定とGAS URL</li>
                    <li><code>gas-code.js / gas-code-ready.js</code> - Google Apps Scriptコード</li>
                    <li><code>readme.html</code> - このファイル（使い方ガイド）</li>
                    <li><code>README.md</code> - マークダウン版ドキュメント</li>
                    <li><code>更新履歴.md</code> - 変更履歴</li>
                    <li><code>今後の予定.md</code> - 開発メモ・TODO</li>
                    <li><code>Google Cloud Console設定手順.md</code> - OAuth設定手順</li>
                </ul>
            </div>

            <!-- 更新履歴 -->
            <div class="section">
                <h2>📝 更新履歴</h2>

                <h3>2025年11月17日</h3>
                <ul>
                    <li>🐛 <strong>角度を求めるモードの選択ボタン表示不具合を修正</strong>
                        <ul>
                            <li>タップ後にボタンが白くなり選択した角度が見えなくなる問題を修正</li>
                            <li>iPadなどのタッチデバイスでフォーカスが当たると白背景になる不具合を解消</li>
                            <li>toggleAngleSelection関数にフォーカスを外す処理を追加</li>
                            <li>CSSで:not(.selected)を使用し、選択済みボタンは選択状態を維持</li>
                            <li>選択済みボタンに!importantを追加して確実にスタイルを適用</li>
                        </ul>
                    </li>
                </ul>

                <h3>2025年11月7日</h3>
                <ul>
                    <li>🔧 <strong>カンニング防止機能の誤検知を修正</strong>
                        <ul>
                            <li>テスト開始直後の画面遷移でresizeイベントが発火し、誤ってリセットされる問題を修正</li>
                            <li>画面遷移完了後500ms待ってから画面サイズを記録</li>
                            <li>さらに2秒間の猶予期間を設けてから監視を開始（合計2.5秒の猶予）</li>
                            <li>monitoringEnabledフラグで監視の有効/無効を制御</li>
                            <li>すべてのカンニング防止イベントに監視フラグを適用</li>
                        </ul>
                    </li>
                </ul>

                <h3>2025年11月6日</h3>
                <ul>
                    <li>🔧 <strong>送信失敗時の手動再送信ボタン表示を改善</strong>
                        <ul>
                            <li>ボタンの表示を確実にするため、style.displayも明示的に設定</li>
                            <li>デバッグログを追加してボタンの存在確認を強化</li>
                            <li>resetQuiz時に送信状態とボタンを完全にリセット</li>
                            <li>送信失敗時にボタンが表示されない不具合を修正</li>
                        </ul>
                    </li>
                </ul>

                <h3>2025年11月5日</h3>
                <ul>
                    <li>🔒 <strong>カンニング防止機能を実装</strong>
                        <ul>
                            <li>アプリ切り替え検出: 他のアプリに切り替えたらテストリセット</li>
                            <li>ウィンドウフォーカス監視: フォーカスが外れたらテストリセット</li>
                            <li>画面サイズ変更検出: Split Viewなど画面分割したらテストリセット</li>
                            <li>テスト開始時に画面サイズを記録し、50px以上の変更で検出</li>
                            <li>デバウンス処理（300ms）で誤検知を防止</li>
                        </ul>
                    </li>
                </ul>

                <h3>2025年10月31日</h3>
                <ul>
                    <li>🐛 <strong>iPadタッチ操作の不具合修正</strong>
                        <ul>
                            <li>回答ボタンをタップ後、次の問題で枠色が残る問題を修正</li>
                            <li>:hover、:focus、:focus-visible疑似クラスの制御を強化</li>
                            <li>タッチデバイス用のスタイルリセット処理を追加</li>
                            <li>blur()とスタイル強制リセットで確実に状態をクリア</li>
                        </ul>
                    </li>
                </ul>

                <h3>2025年10月30日</h3>
                <ul>
                    <li>🔄 <strong>データ送信の信頼性向上</strong>
                        <ul>
                            <li>自動リトライ機能（最大3回、3秒間隔）</li>
                            <li>送信状態の可視化（送信中→再送信中→送信完了/失敗）</li>
                            <li>手動再送信ボタンの追加</li>
                            <li>CORSエラー時の自動フォールバック</li>
                        </ul>
                    </li>
                    <li>📱 <strong>iPad対応の強化</strong>
                        <ul>
                            <li>縦画面での慣性スクロール問題を完全修正</li>
                            <li>説明画面で確実にボタンが押せるように改善</li>
                        </ul>
                    </li>
                    <li>⚙️ <strong>Google Apps Script機能追加</strong>
                        <ul>
                            <li>テスト開始/終了時刻をF1/G1セルに記録する関数を追加</li>
                        </ul>
                    </li>
                </ul>

                <h3>2025年10月27日</h3>
                <ul>
                    <li>✨ <strong>角度を求めるモード追加</strong>
                        <ul>
                            <li>「値を求める」「角度を求める」の2モード対応</li>
                            <li>メニュー画面と説明画面の追加</li>
                        </ul>
                    </li>
                    <li>🗑️ <strong>練習モード削除</strong>
                        <ul>
                            <li>常に全問題を出題（値: 27問、角度: 21問）</li>
                            <li>すべての結果をスプレッドシートに記録</li>
                        </ul>
                    </li>
                    <li>📊 <strong>スプレッドシート強化</strong>
                        <ul>
                            <li>H列に「テストタイプ」を追加</li>
                        </ul>
                    </li>
                </ul>

                <h3>2025年10月26日</h3>
                <ul>
                    <li>✨ 問題文をTeX表記（KaTeX）で美しく表示</li>
                    <li>✨ 選択肢を値の大きさ順に並べる4列レイアウトに変更</li>
                </ul>

                <h3>2025年10月23日</h3>
                <ul>
                    <li>🎉 初版リリース</li>
                    <li>✅ Google OAuth 2.0認証実装</li>
                    <li>✅ Google Apps Script連携完了</li>
                    <li>✅ GitHub Pages公開</li>
                </ul>
            </div>
        </div>

        <footer>
            <p><strong>三角比小テスト</strong></p>
            <p>作成日: 2025年10月23日 | 最終更新: 2025年11月17日</p>
            <p>状態: <span class="status-badge status-success">✓ 本番運用中（2モード・カンニング防止機能付き）</span></p>
            <p style="margin-top: 15px;">&copy;2025 IshiyamaYoshihiro</p>
        </footer>
    </div>

    <script>
        // クリップボードにコピーする関数
        function copyToClipboard(text, button) {
            // navigator.clipboard APIを使用
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    // コピー成功時の処理
                    const originalText = button.textContent;
                    button.textContent = '✓ コピー完了！';
                    button.classList.add('copied');

                    // 2秒後に元に戻す
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('コピーに失敗しました:', err);
                    alert('コピーに失敗しました');
                });
            } else {
                // 古いブラウザ用のフォールバック
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();

                try {
                    document.execCommand('copy');
                    const originalText = button.textContent;
                    button.textContent = '✓ コピー完了！';
                    button.classList.add('copied');

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    console.error('コピーに失敗しました:', err);
                    alert('コピーに失敗しました');
                }

                document.body.removeChild(textarea);
            }
        }
    </script>
</body>
</html>
